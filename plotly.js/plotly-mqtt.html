<!DOCTYPE html>
<html>
<head>
<title>Real time Plotly javascript mqtt example</title>
<meta charset="UTF-8">
<script type="text/javascript" src="plotly-latest.min.js"></script>
<script type="text/javascript" src="mqttws31.min.js"></script>

<style type="text/css">
#graph {
  width: 100%;
  height: 800px;
}
</style>

</head>

<body>

<div id="graph"></div>


<script type="text/javascript">

var trace1 = {
  x: [],
  y: [],
  name: 'IR Lämpötila °C',
  type: 'scatter'
};

var trace2 = {
  x: [],
  y: [],
  xaxis: 'x2',
  yaxis: 'y2',
  name: 'Valoisuus lx',
  type: 'scatter'
};

var trace3 = {
  x: [],
  y: [],
  xaxis: 'x3',
  yaxis: 'y3',
  name: 'Ilmankosteus %',
  type: 'scatter'
};

var trace3b = {
  x: [],
  y: [],
  xaxis: 'x3',
  yaxis: 'y3',
  name: 'Ilman lämpötila °C',
  type: 'scatter'
};

var trace4 = {
  x: [],
  y: [],
  xaxis: 'x4',
  yaxis: 'y4',
  name: 'Väri R',
  type: 'scatter'
};

var trace4b = {
  x: [],
  y: [],
  xaxis: 'x4',
  yaxis: 'y4',
  name: 'Väri G',
  type: 'scatter'
};

var trace4c = {
  x: [],
  y: [],
  xaxis: 'x4',
  yaxis: 'y4',
  name: 'Väri B',
  type: 'scatter'
};

var data = [trace1, trace2, trace3, trace3b, trace4, trace4b, trace4c];

var layout = {
    xaxis: {
        domain: [0, 0.45],
        type: 'date'
    },
    yaxis: {
        title: "IR lämpötila",
        domain: [0, 0.45],
        range: [0, 100]
    },
    xaxis2: {
        domain: [0.55, 1],
        type: 'date'
    },
    yaxis2: {
        title: "Valoisuus",
        domain: [0, 0.45],
        range: [0, 100],
        anchor: 'x2'
    },
    xaxis3: {
        domain: [0, 0.45],
        type: 'date',
        anchor: 'y3'
    },
    yaxis3: {
        title: "Kosteus ja lämpö",
        domain: [0.55, 1],
        range: [0, 100]
    },
    xaxis4: {
        domain: [0.55, 1],
        type: 'date',
        anchor: 'y4'
    },
    yaxis4: {
        title: "Valon väri ja ele",
        domain: [0.55, 1],
        range: [0, 100],
        anchor: 'x4'
    }
};

Plotly.plot('graph', data, layout);


// Create a client instance
// client = new Paho.MQTT.Client(location.hostname, Number(location.port), "clientId");
client = new Paho.MQTT.Client("192.168.0.40", 9001, "clientId"+Math.random());

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect});

// called when the client connects
function onConnect() {
  // Once a connection has been made, make a subscription and send a message.
  console.log("onConnect");
  client.subscribe("moi");
  message = new Paho.MQTT.Message("Hello");
  message.destinationName = "World";
  //client.send(message);
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
  }
  //client.connect({onSuccess:onConnect});
}

// called when a message arrives
function onMessageArrived(message) {
  console.log("onMessageArrived:"+message.payloadString);
  var  data = JSON.parse(message.payloadString);
  console.log(data);
  var time = new Date();
  var olderTime = time.setMinutes(time.getMinutes() - 3);
  var futureTime = time.setMinutes(time.getMinutes() + 3);
  var minuteView = layout;
  minuteView.xaxis.range = [olderTime,futureTime];
  minuteView.xaxis2.range = [olderTime,futureTime];
  minuteView.xaxis3.range = [olderTime,futureTime];
  minuteView.xaxis4.range = [olderTime,futureTime];

  Plotly.relayout('graph', minuteView);
  if (data.sensor == 'humitemp') {
    var update = {
      x: [[time], [time]],
      y: [[data.data[1]], [data.data[3]]]
    };
    Plotly.extendTraces('graph', update, [2,3]);
  }
  if (data.sensor == 'irtemp') {
    var update = {
      x: [[time]],
      y: [[data.data[1]]]
    };
    Plotly.extendTraces('graph', update, [0]);
  }

}
      
    </script>

  </body>
</html>
